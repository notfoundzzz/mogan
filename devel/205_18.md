# 205_18 修复 Art Frame 崩溃

## 如何测试
1. 启动 Mogan。
2. 新建空文档。
3. 点击 `插入 -> 外观块 -> Art Frame -> Carved Wood/black floral I`。
4. 预期：不崩溃，外观块正常显示。

## 2026/02/05 

### What
复现场景中，点击 `插入 -> 外观块 -> Art Frame -> Carved Wood` 会直接崩溃。  
根因是 `src/Plugins/MuPDF/mupdf_picture.cpp` 中像素读写实现对底层缓冲区做了固定 4 字节像素的假设：
- 直接将 `samples` 强转为 `color*` 访问；
- 忽略了 MuPDF pixmap 的真实 `n`（通道数）和 `stride`（行步长）；
- 在某些图像布局下会读错甚至越界，最终触发段错误。

修复内容：
1. 为 `internal_get_pixel` / `internal_set_pixel` 增加坐标边界保护。
2. 按 MuPDF pixmap 的实际 `n/stride/alpha` 进行读写，不再使用 `color*` 强转访问。
3. 在 alpha 场景下保持预乘/反预乘处理，兼容灰度、灰度+alpha、RGB、RGBA 路径。

### Why
`Art Frame` 会走图片 effect 链（含透明和裁剪），该链路对像素访问非常密集。  
底层像素布局假设错误会在该场景被稳定放大，导致崩溃。  
修复后，像素访问与 MuPDF pixmap 内存布局一致，避免越界和非法读取。
