# 209_7 增加bash代码块及高亮支持

## 如何测试

1. 选择菜单插入-程序-代码块/行内代码或使用 `\bash` 或者 `\bash-code`插入代码块环境
2. 输入一些Bash代码检查高亮
- 测试文档: TeXmacs/tests/tmu/209_7.tmu

## 文件位置
- 语言定义：TeXmacs/plugins/bash/progs/data/bash.scm
- 样式包：TeXmacs/plugins/bash/packages/code/bash.ts
- 编辑功能：TeXmacs/plugins/bash/progs/code/bash-edit.scm
- 高亮功能：TeXmacs/plugins/bash/progs/code/bash-lang.scm
- 文档：TeXmacs/plugins/bash/doc/bash.en.tmu

## 2026/01/26 修复 Bash 代码模式下 `#` 被误识别为注释


**特殊参数/参数展开中的 `#` 被错误识别为注释起始符**

   - `$#`（参数个数）中的 `#` 被渲染为注释颜色  
   - `${#backups[@]}`（数组长度）中的 `#` 被渲染为注释颜色  

### Why

Bash 中的 `#` 同时出现在注释、特殊参数和参数展开语法中，一律按注释处理会导致误导。

### How

#### 1. 修复注释识别逻辑（仅针对 Bash）

文件：`src/System/Language/prog_language.cpp:312-335`

- 在 `get_color()` 函数中增加 Bash 特殊处理规则：
  - 仅当 `#` 位于行首或前面为空白字符时，才识别为注释
  - `$#` 与 `${#...}` 中的 `#` 不再被识别为注释

覆盖用例：

- `$#`
- `${#var}`
- `${#arr[@]}`

## 2026/01/23 修复bash代码模式下文件名路径等的错误高亮
### What 

修复了 Bash代码模式下，路径、文件名、URL、连字符等场景中命令名和数字被错误高亮的问题，包括：

-   路径 / 文件名中的命令误高亮（abc.git、abc/git、nvim-linux.taz）
-   URL 中的命令误高亮（git clone git@gitee.com:xxx.git）
-   文件名中的数字误高亮（209.in、209_9.tmu、file-1.txt）
-   负数与算术表达式高亮异常（-1、1-2）

同时保证独立命令、独立数字及算术表达式仍能正确高亮，仅影响 Bash 语言。


### How

#### 1. 关键字解析器边界检查

文件：src/Data/Parser/keyword_parser.cpp

-   增加 check_path_boundaries 开关
-   在 can_parse() 中补充边界判断：
    -   禁止在路径、URL、单词字符、连字符、下划线后匹配关键字
    -   禁止关键字后直接连接路径符号或连字符

避免 abc.git、abc/git、nvim-linux.taz 等误高亮。


#### 2. 数字解析器边界检查

文件：src/Data/Parser/number_parser.cpp

-   增加 check_path_boundaries 开关
-   在 can_parse() 中：
    -   禁止路径、URL、单词字符前匹配数字
    -   对连字符进行智能判断（区分 file-1 与 -1）
-   在 do_parse() 中：
    -   避免 1-file.txt 误解析
    -   保留 1-2 等算术表达式

同时将 parse\_\* 的严格检查限制为仅在边界模式下生效，避免影响其他语言。


#### 3. Bash 专用启用

文件：src/System/Language/prog_language.cpp

-   仅为 Bash 启用关键字与数字解析器的边界检查
-   其他语言保持原有行为

### Why

-   避免路径、文件名、URL 中的命令误高亮
-   避免文件名中的数字被错误识别
-   保证负数与算术表达式正常显示
-   保持 Bash 代码可读性
-   限定修改范围，避免影响其他语言


## 2026/01/23 修复bash代码模式下文件名路径等的错误高亮
### What 

修复了 Bash代码模式下，路径、文件名、URL、连字符等场景中命令名和数字被错误高亮的问题，包括：

-   路径 / 文件名中的命令误高亮（abc.git、abc/git、nvim-linux.taz）
-   URL 中的命令误高亮（git clone git@gitee.com:xxx.git）
-   文件名中的数字误高亮（209.in、209_9.tmu、file-1.txt）
-   负数与算术表达式高亮异常（-1、1-2）

同时保证独立命令、独立数字及算术表达式仍能正确高亮，仅影响 Bash 语言。


### How

#### 1. 关键字解析器边界检查

文件：src/Data/Parser/keyword_parser.cpp

-   增加 check_path_boundaries 开关
-   在 can_parse() 中补充边界判断：
    -   禁止在路径、URL、单词字符、连字符、下划线后匹配关键字
    -   禁止关键字后直接连接路径符号或连字符

避免 abc.git、abc/git、nvim-linux.taz 等误高亮。


#### 2. 数字解析器边界检查

文件：src/Data/Parser/number_parser.cpp

-   增加 check_path_boundaries 开关
-   在 can_parse() 中：
    -   禁止路径、URL、单词字符前匹配数字
    -   对连字符进行智能判断（区分 file-1 与 -1）
-   在 do_parse() 中：
    -   避免 1-file.txt 误解析
    -   保留 1-2 等算术表达式

同时将 parse\_\* 的严格检查限制为仅在边界模式下生效，避免影响其他语言。


#### 3. Bash 专用启用

文件：src/System/Language/prog_language.cpp

-   仅为 Bash 启用关键字与数字解析器的边界检查
-   其他语言保持原有行为

### Why

-   避免路径、文件名、URL 中的命令误高亮
-   避免文件名中的数字被错误识别
-   保证负数与算术表达式正常显示
-   保持 Bash 代码可读性
-   限定修改范围，避免影响其他语言

## 2025/01/22
### What
补充了bash-lang.scm中语法高亮的定义，增加了
- **外部命令高亮（external_command）**
  - GNU coreutils
  - 常用开发工具，如 `git`、`gh`、`code`、`claude`
  - 常用 alias（如 `ll`、`gco`）


## 2025/01/20
### What
为Mogan STEM添加Bash代码的语法高亮支持，包括语言定义文件和样式包。

### Why
满足用户的插入Bash代码需求

关联 issue #2607