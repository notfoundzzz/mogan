# 203_23 修复 LaTeX 导入分段函数排版错位


## 如何测试

1. 打开 Mogan，新建空白文档，在数学模式导入：

```latex
f(x)=\left\{\begin{aligned}
-x^{2}+1&\quad x\neq0\\
0&\quad x=0
\end{aligned}\right.
```

预期：
- 左大括号覆盖两行分段内容；
- 两行按 `&` 对齐；
- `f(x)` 与分段函数整体垂直居中对齐；
- `=` 不被错误推到最右侧。

2. 在普通文本模式执行“智能粘贴”（`Ctrl+Shift+V`）粘贴同样内容。  
预期：软件不崩溃，公式片段可正常插入。

3. 回归检查 `alignedat`、`cases`、`matrix` 场景。  
预期：不崩溃、排版不回归。

测试文档：`TeXmacs/tests/tmu/203_23.tmu`



## 2025/2/4 修复非数学模式智能粘贴崩溃

### Why

- 在非数学模式下执行智能粘贴，输入

```latex
f(x)=\left\{\begin{aligned}
-x^{2}+1&\quad x\neq0\\
0&\quad x=0
\end{aligned}\right.
```

会触发崩溃。

- 根因是：后处理阶段生成了 `tabular* / LEFT / RIGHT` 等数学布局节点，但外层仍是文本语义，后续排版阶段可能按文本路径处理并崩溃。

### What

- 为 `aligned/alignedat` 相关矩阵化路径增加“局部数学容器”防护。
- 非数学上下文中，仅对当前公式子树做 `math` 包裹后再矩阵化，不改变全局环境。
- 同时覆盖 `\left ... \begin{aligned} ... \end{aligned} \right.` 组合路径。

### How

- 在 `src/Plugins/Tex/fromtex_post.cpp` 中：
  - 增加数学上下文判断与递归传递（`in_math`）。
  - 对 `aligned/alignedat` 分支在非数学上下文下执行局部 `compound("math", ...)` 包裹。
  - 对 `LEFT + aligned + RIGHT` 组合增加同样的局部包裹逻辑。
  - 关键处补充简要中文注释，说明防崩溃意图。

---

## 2026/2/3 修复 `aligned/alignedat` 导入排版错位

### Why

- 在 `\left\{ ... \right.` 包裹 `aligned/alignedat` 的场景中，导入后未稳定落入行内对齐块，导致括号包裹关系和基线对齐异常。
- 典型表现为：`&` 对齐信息泄漏到外层，`f(x)` 与分段函数整体垂直对齐不正确，`=` 可能被推到最右侧。

### What

- 修复 `aligned/alignedat` 在 LaTeX 导入流程中的解析落点。
- 将分段函数场景中的导入目标统一为行内表格语义（`tabular*`），避免 display 级布局导致错位。
- 补全 `aligned/alignedat` 的 begin/end 匹配路径，确保环境完整折叠为单一排版块。

### How

- 修改 `src/Plugins/Tex/fromtex_post.cpp`：
  - 在 `parse_pmatrix/finalize_pmatrix` 增加 `aligned/aligned*/alignedat/alignedat*` 分支。
  - 对 `alignedat` 参数做防御处理（参数是列对数，不按 array 列格式串解析）。
- 修改 DRD 识别：
  - `TeXmacs/progs/convert/latex/latex-command-drd.scm`
  - `TeXmacs/plugins/latex/progs/convert/latex/latex-command-drd.scm`
  - 补齐 `begin-aligned(*)`、`begin-alignedat(*)` 的数学环境识别。

---